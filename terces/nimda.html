<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CHN LNK Admin Panel</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            color: #e6e6e6;
            background: #0d0d0d;
        }

        h2, h3 {
            color: #f0f0f0;
            margin-bottom: 10px;
        }

        input, button {
            padding: 10px 14px;
            margin: 5px 0;
            border-radius: 6px;
            border: none;
            font-size: 14px;
        }

        input {
            width: 250px;
            background: #1e1e1e;
            color: #fff;
            border: 1px solid #333;
        }

        button {
            background: #333;
            color: #fff;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: #555;
        }

        .primary-btn {
            background: #4da6ff !important;
            color: #fff !important;
            font-weight: bold;
        }

        .primary-btn:hover {
            background: #6bb6ff !important;
        }

        .cancel-btn {
            background: transparent !important;
            color: #aaa !important;
            border: none !important;
            padding-left: 0 !important;
        }

        .cancel-btn:hover {
            color: #ddd !important;
        }

        #adminTools {
            display: none;
            margin-top: 20px;
        }

        #userInfo {
            margin-bottom: 15px;
            opacity: 0.85;
            font-size: 14px;
        }

        .player-table, .oldest-table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1a1a;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px #0005;
        }

        .player-table th, .oldest-table th {
            text-align: left;
            padding: 10px;
            background: #222;
            color: #bbb;
            font-weight: normal;
        }

        .player-table td, .oldest-table td {
            padding: 10px;
            border-top: 1px solid #333;
        }

        .delete-icon {
            cursor: pointer;
            color: #ff4d4d;
            font-size: 18px;
        }

        .edit-icon {
            cursor: pointer;
            color: #4da6ff;
            font-size: 18px;
            padding-left: 15px;
        }

        #oldestContainer {
            margin-top: 40px;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 15px;
            background: #141414;
            border-radius: 8px;
            box-shadow: 0 0 10px #0005;
        }

        .button-row, .right-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .button-row button, .right-buttons button {
            flex: 1;
        }

        @media (max-width: 600px) {
            input {
                width: 100% !important;
                box-sizing: border-box;
            }

            button {
                width: 100%;
                font-size: 16px;
                padding: 12px;
                margin-top: 8px;
            }

            .button-row,
            .right-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .player-table,
            .oldest-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>

<h2>CHN LNK Admin</h2>

<div id="loadingMessage">Checking authentication‚Ä¶</div>

<div id="loginBox" style="display:none;">
    <p>Login with your Google account.</p>
    <button onclick="googleLogin()">Sign in with Google</button>
    <p id="loginError" style="color:red;"></p>
</div>

<div id="adminTools">
    <div id="userInfo"></div>

    <h3>Player Lookup</h3>
    <input id="playerName" placeholder="Player name" autocomplete="on">
    <button onclick="findPlayer()">Find Player</button>
    <button onclick="clearPlayerSearch()">Clear</button>

    <h3>Result</h3>
    <div id="result">No action yet.</div>

    <div id="oldestContainer">
        <div class="button-row">
            <button onclick="loadOldest()">Show 25 Oldest</button>
            <button onclick="loadNewest()">Show 25 Newest</button>
            <button onclick="loadPreviousMonth()">Show Previous Month</button>
        </div>

        <div class="right-buttons">
            <button onclick="clearOldest()">Clear Results</button>
            <button onclick="deleteAllShown()">Delete All Shown</button>
        </div>

        <div id="oldestTable"></div>
    </div>

    <button onclick="logout()">Logout</button>
    <div id="logoutMessage"></div>
</div>

<script type="module">
/* ---------------------------------------------------------
   Firebase Imports
--------------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
    getFirestore,
    collection,
    query,
    doc,
    where,
    limit,
    getDocs,
    deleteDoc,
    orderBy,
    updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------------------------------------------------------
   Firebase Config
--------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyCyAxFfNR7h77tG7qOYjZEXiPVepe4pqPg",
    authDomain: "chn-lnk.firebaseapp.com",
    projectId: "chn-lnk",
    storageBucket: "chn-lnk.firebasestorage.app",
    messagingSenderId: "417710575115",
    appId: "1:417710575115:web:337f0eb082fe6a1a7e810e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------------------------------------------------
   Admin UID
--------------------------------------------------------- */
const ADMIN_UID = "6RHgg6dr8NcI5m4BjMI1rg0LidE2";
/* ---------------------------------------------------------
   UI Elements
--------------------------------------------------------- */
const loginBox = document.getElementById("loginBox");
const adminTools = document.getElementById("adminTools");
const loadingMessage = document.getElementById("loadingMessage");
const loginError = document.getElementById("loginError");
const userInfo = document.getElementById("userInfo");
const logoutMessage = document.getElementById("logoutMessage");

/* ---------------------------------------------------------
   Login / Logout
--------------------------------------------------------- */
async function googleLogin() {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
    } catch (err) {
        loginError.textContent = err.message;
    }
}

async function logout() {
    try {
        await signOut(auth);
        logoutMessage.textContent = "Successfully logged out.";
    } catch (err) {
        console.error(err);
    }
}

/* ---------------------------------------------------------
   Auth State
--------------------------------------------------------- */
onAuthStateChanged(auth, user => {
    loadingMessage.style.display = "none";

    if (!user) {
        loginBox.style.display = "block";
        adminTools.style.display = "none";
        return;
    }

    if (user.uid !== ADMIN_UID) {
        loginBox.style.display = "none";
        adminTools.style.display = "none";
        document.body.innerHTML = `
            <div style="text-align:center;margin-top:40px;color:#e6e6e6;font-family:Arial;">
                <h2 style="color:#ff4d4d;">Access Denied</h2>
                <p>You are not authorized to view this page.</p>
                <button id="forceLogoutBtn"
                    style="
                        margin-top:20px;
                        padding:10px 20px;
                        background:#333;
                        color:#fff;
                        border:none;
                        border-radius:6px;
                        cursor:pointer;
                        font-size:16px;
                    ">
                    Logout
                </button>
            </div>
        `;

        document.getElementById("forceLogoutBtn").onclick = async () => {
            try {
                await signOut(auth);
                location.reload();
            } catch (err) {
                console.error(err);
            }
        };
        return;
    }

    loginBox.style.display = "none";
    adminTools.style.display = "block";
    userInfo.textContent = "Logged in as: " + user.email;
});

/* ---------------------------------------------------------
   Expose login/logout
--------------------------------------------------------- */
window.googleLogin = googleLogin;
window.logout = logout;

/* ---------------------------------------------------------
   Admin State
--------------------------------------------------------- */
let lastFoundDoc = null;
let lastShownDocs = [];
let foundPlayers = [];
let currentIndex = 0;
let editMode = false;

/* ---------------------------------------------------------
   Timestamp Formatter
--------------------------------------------------------- */
function formatTS(ts) {
    if (!ts) return "-";
    const d = ts.toDate();
    return d.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
    }).replace(",", " at");
}

/* ---------------------------------------------------------
   Render Normal Table
--------------------------------------------------------- */
function renderTable(data) {
    return `
    <table class="player-table">
        <tr><th>Name</th><td>${data.name}</td></tr>
        <tr><th>Played</th><td>${data.played}</td></tr>
        <tr><th>Wins</th><td>${data.wins}</td></tr>
        <tr><th>Win %</th><td>${data.winpct}%</td></tr>
        <tr><th>Stars</th><td>${data.stars}</td></tr>
        <tr><th>Dynamite</th><td>${data.dynamite}</td></tr>
        <tr><th>Updated</th><td>${formatTS(data.updated)}</td></tr>

        <tr><th>Total Played</th><td>${data.ztplayed}</td></tr>
        <tr><th>Total Wins</th><td>${data.ztwins}</td></tr>
        <tr><th>Total Stars</th><td>${data.ztstars}</td></tr>
        <tr><th>Total Streak</th><td>${data.ztstreak}</td></tr>

        <tr><th>‚≠ê Breakdown</th>
            <td>
                ‚≠ê1√ó${data.zzstar1} &nbsp;
                ‚≠ê2√ó${data.zzstar2} &nbsp;
                ‚≠ê3√ó${data.zzstar3} &nbsp;
                ‚≠ê4√ó${data.zzstar4} &nbsp;
                ‚≠ê5√ó${data.zzstar5} &nbsp;
                ‚ùå√ó${data.zzstarx}
            </td>
        </tr>

        <tr>
            <th>Actions</th>
            <td>
                <span class="delete-icon" onclick="deletePlayer()">üóëÔ∏è</span>
                <span class="edit-icon" onclick="enterEditMode()">‚úèÔ∏è</span>
            </td>
        </tr>
    </table>`;
}

/* ---------------------------------------------------------
   Render Editable Table
--------------------------------------------------------- */
function renderEditableTable(data) {
    return `
    <table class="player-table">
        <tr><th>Name</th><td>${data.name}</td></tr>

        <tr><th>Played</th><td><input type="number" id="edit-played" value="${data.played}"></td></tr>
        <tr><th>Wins</th><td><input type="number" id="edit-wins" value="${data.wins}"></td></tr>
        <tr><th>Stars</th><td><input type="number" id="edit-stars" value="${data.stars}"></td></tr>
        <tr><th>Dynamite</th><td><input type="number" id="edit-dynamite" value="${data.dynamite}"></td></tr>

        <tr><th>Total Played</th><td><input type="number" id="edit-ztplayed" value="${data.ztplayed}"></td></tr>
        <tr><th>Total Wins</th><td><input type="number" id="edit-ztwins" value="${data.ztwins}"></td></tr>
        <tr><th>Total Stars</th><td><input type="number" id="edit-ztstars" value="${data.ztstars}"></td></tr>
        <tr><th>Total Streak</th><td><input type="number" id="edit-ztstreak" value="${data.ztstreak}"></td></tr>

        <tr><th>‚≠ê1</th><td><input type="number" id="edit-zzstar1" value="${data.zzstar1}"></td></tr>
        <tr><th>‚≠ê2</th><td><input type="number" id="edit-zzstar2" value="${data.zzstar2}"></td></tr>
        <tr><th>‚≠ê3</th><td><input type="number" id="edit-zzstar3" value="${data.zzstar3}"></td></tr>
        <tr><th>‚≠ê4</th><td><input type="number" id="edit-zzstar4" value="${data.zzstar4}"></td></tr>
        <tr><th>‚≠ê5</th><td><input type="number" id="edit-zzstar5" value="${data.zzstar5}"></td></tr>
        <tr><th>‚ùå</th><td><input type="number" id="edit-zzstarx" value="${data.zzstarx}"></td></tr>

        <tr>
            <th>Actions</th>
            <td>
                <button class="primary-btn" onclick="savePlayerEdits()">Save Changes</button>
                <button class="cancel-btn" onclick="cancelEditMode()">Cancel</button>
            </td>
        </tr>
    </table>`;
}

/* ---------------------------------------------------------
   Enter Edit Mode
--------------------------------------------------------- */
function enterEditMode() {
    if (!lastFoundDoc) return;
    editMode = true;
    result.innerHTML = renderEditableTable(lastFoundDoc.data());
}

/* ---------------------------------------------------------
   Cancel Edit Mode
--------------------------------------------------------- */
function cancelEditMode() {
    editMode = false;
    showPlayerAtIndex(currentIndex);
}
/* ---------------------------------------------------------
   Save Player Edits (only changed fields)
--------------------------------------------------------- */
async function savePlayerEdits() {
    if (!lastFoundDoc) return;

    const original = lastFoundDoc.data();
    const updates = {};

    function check(field) {
        const el = document.getElementById("edit-" + field);
        if (!el) return;
        const newVal = Number(el.value);
        if (newVal !== original[field]) updates[field] = newVal;
    }

	const editableFields = [
		"played", "wins", "stars", "dynamite",
		"ztplayed", "ztwins", "ztstars", "ztstreak",
		"zzstar1", "zzstar2", "zzstar3", "zzstar4", "zzstar5", "zzstarx"
	];

	editableFields.forEach(check);

	// ‚≠ê Auto‚Äërecompute winpct ONLY if wins or played changed
	if ("wins" in updates || "played" in updates) {
		const newWins = updates.wins !== undefined ? updates.wins : original.wins;
		const newPlayed = updates.played !== undefined ? updates.played : original.played;

		let newPct = 0;
		if (newPlayed > 0) {
			newPct = Math.floor((newWins / newPlayed) * 100);
		}

		if (newPct !== original.winpct) {
			updates.winpct = newPct;
		}
	}

    if (Object.keys(updates).length === 0) {
        alert("No changes detected.");
        cancelEditMode();
        return;
    }

    await updateDoc(lastFoundDoc.ref, updates);

    alert("Player updated.");
    editMode = false;

    // Refresh the doc
    const refreshed = await getDocs(query(
        collection(db, "leaderboard"),
        where("name", "==", original.name),
        limit(5)
    ));

    foundPlayers = refreshed.docs;
    lastFoundDoc = foundPlayers[currentIndex];

    showPlayerAtIndex(currentIndex);
}

/* ---------------------------------------------------------
   Player Lookup (with pagination)
--------------------------------------------------------- */
async function findPlayer() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return;

    const q = query(
        collection(db, "leaderboard"),
        where("name", "==", name),
        limit(5)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
        result.innerHTML = "Player not found.";
        foundPlayers = [];
        lastFoundDoc = null;
        return;
    }

    foundPlayers = snap.docs;
    currentIndex = 0;

    showPlayerAtIndex(currentIndex);
}

function showPlayerAtIndex(i) {
    const docSnap = foundPlayers[i];
    lastFoundDoc = docSnap;

    const data = docSnap.data();

    result.innerHTML = `
        ${renderTable(data)}
        <div style="margin-top:10px; display:flex; justify-content:space-between;">
            <button onclick="prevPlayer()" ${i === 0 ? "disabled" : ""}>‚¨Ö Prev</button>
            <span style="padding:8px 12px; opacity:0.8;">
                ${i + 1} / ${foundPlayers.length}
            </span>
            <button onclick="nextPlayer()" ${i === foundPlayers.length - 1 ? "disabled" : ""}>Next ‚û°</button>
        </div>
    `;
}

function nextPlayer() {
    if (currentIndex < foundPlayers.length - 1) {
        currentIndex++;
        showPlayerAtIndex(currentIndex);
    }
}

function prevPlayer() {
    if (currentIndex > 0) {
        currentIndex--;
        showPlayerAtIndex(currentIndex);
    }
}

function clearPlayerSearch() {
    result.innerHTML = "No action yet.";
    lastFoundDoc = null;
    foundPlayers = [];
    currentIndex = 0;
    document.getElementById("playerName").value = "";
}

/* ---------------------------------------------------------
   Delete Player
--------------------------------------------------------- */
async function deletePlayerById(id) {
    const ok = confirm(`Delete player "${id}" permanently?`);
    if (!ok) return;

    await deleteDoc(doc(db, "leaderboard", id));

    const row = document.getElementById("row-" + id);
    if (row) row.remove();
}

async function deletePlayer() {
    if (!lastFoundDoc) return alert("Find a player first.");
    await deletePlayerById(lastFoundDoc.id);
    result.innerHTML = "Player deleted.";
    lastFoundDoc = null;
}

/* ---------------------------------------------------------
   Oldest/Newest/Previous Month Queries
--------------------------------------------------------- */
function clearOldest() {
    oldestTable.innerHTML = "";
    lastShownDocs = [];
}

async function deleteAllShown() {
    if (lastShownDocs.length === 0) return alert("No records to delete.");
    if (!confirm(`Delete all ${lastShownDocs.length} shown records permanently?`)) return;

    for (const id of lastShownDocs) {
        await deleteDoc(doc(db, "leaderboard", id));
    }

    oldestTable.innerHTML = "";
    lastShownDocs = [];
}

async function loadOldest() {
    const q = query(
        collection(db, "leaderboard"),
        orderBy("updated", "asc"),
        limit(25)
    );

    const snap = await getDocs(q);
    renderListResults(snap);
}

async function loadNewest() {
    const q = query(
        collection(db, "leaderboard"),
        orderBy("updated", "desc"),
        limit(25)
    );

    const snap = await getDocs(q);
    renderListResults(snap);
}

async function loadPreviousMonth() {
    const now = new Date();
    const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

    const q = query(
        collection(db, "leaderboard"),
        where("updated", "<", prevMonth),
        orderBy("updated", "asc"),
        limit(50)
    );

    const snap = await getDocs(q);
    renderListResults(snap);
}

/* ---------------------------------------------------------
   Render List Results
--------------------------------------------------------- */
function renderListResults(snap) {
    lastShownDocs = [];

    let html = `
    <table class="oldest-table">
        <tr>
            <th>Name</th>
            <th>Stars</th>
            <th>Wins</th>
            <th>Played</th>
            <th>Updated</th>
            <th></th>
        </tr>
    `;

    snap.forEach(docSnap => {
        const d = docSnap.data();
        lastShownDocs.push(docSnap.id);

        html += `
        <tr id="row-${docSnap.id}">
            <td>${d.name}</td>
            <td>${d.stars}</td>
            <td>${d.wins}</td>
            <td>${d.played}</td>
            <td>${formatTS(d.updated)}</td>
            <td><span class="delete-icon" onclick="deletePlayerById('${docSnap.id}')">üóëÔ∏è</span></td>
        </tr>`;
    });

    html += "</table>";
    oldestTable.innerHTML = html;
}

/* ---------------------------------------------------------
   Expose functions
--------------------------------------------------------- */
window.findPlayer = findPlayer;
window.clearPlayerSearch = clearPlayerSearch;
window.deletePlayer = deletePlayer;
window.updateDynamite = () => {}; // no longer used
window.loadOldest = loadOldest;
window.loadNewest = loadNewest;
window.loadPreviousMonth = loadPreviousMonth;
window.clearOldest = clearOldest;
window.deleteAllShown = deleteAllShown;
window.deletePlayerById = deletePlayerById;
window.nextPlayer = nextPlayer;
window.prevPlayer = prevPlayer;
window.showPlayerAtIndex = showPlayerAtIndex;
window.enterEditMode = enterEditMode;
window.cancelEditMode = cancelEditMode;
window.savePlayerEdits = savePlayerEdits;

</script>
</body>
</html>

